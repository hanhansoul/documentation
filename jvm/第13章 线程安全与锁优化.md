# 线程安全与锁优化

## 线程安全

线程安全这一概念针对的目标是对象实例。

当多个线程访问一个对象时，如果不用考虑这些线程在运行时环境下的调度和交替执行，也不需要进行额外的同步，或者再调用方进行任何其他的协调操作，调用这个对象的行为都可以获得正确的结果，那这个对象就是线程安全的。

### Java语言中的线程安全

Java中的共享数据分为五类：
1. 不可变
2. 绝对线程安全
3. 相对线程安全
4. 线程兼容
5. 线程对立

#### 不可变

不可变对象一定是线程安全的，无论是对象的方法还是方法的调用者，都不需要额外的线程安全保障措施。

- 基本数据类型：定义时使用final关键字修饰；
- 对象：需要保证对象的行为不会对其状态产生任何影响。

#### 绝对线程安全

#### 相对线程安全

#### 线程兼容

#### 线程对立

### 线程安全的实现方法

#### 互斥同步

同步是指在多个线程并发访问共享数据时，保证共享数据在同一个时刻只被一条线程使用。

互斥同步最主要的问题是进行线程阻塞和唤醒所带来的性能问题，因此互斥同步也被称为阻塞同步，属于一种悲观的并发策略。

互斥是实现同步的一种手段：
1. 临界区
2. 互斥量
3. 信号量
4. synchronized关键字

**synchronized关键字**

- synchronized同步块对同一条线程来说是可重入的，不会出现自己把自己锁死的情况。
- 同步块在已进入的线程执行之前，会阻塞后面其他线程的进入。

**ReentrantLock**

1. 等待可中断：指当持有锁的线程长期不释放锁的时候，正在等待的线程可以选择放弃等待，改为处理其他事；
2. 公平锁：多个线程等待同一个锁时，必须按照申请锁的时间顺序来依次获得锁；
3. 锁可以绑定多个条件：一个ReentrantLock对象可以同时绑定多个Condition对象。

#### 非阻塞同步

非阻塞同步是一种基于冲突检测的乐观并发策略，即先进行操作，若没有其他线程争用共享数据，则操作成功，否则进行其他补偿措施。

CAS操作的ABA问题，JUC包通过提供一个带有标记的原子引用类，控制变量值的版本来保证CAS的正确性。

#### 无同步方案

- 可重入代码：在代码执行的任何时刻中断它，转而执行另外一段代码，而在控制权返回后，原来的程序不会出现任何错误。特点：不依赖存储在堆上的数据和公用的系统资源、用到的状态量都是由参数中传入的，不调用非可重用的方法。
- 线程本地存储：如果一个变量要被多个线程访问，可以使用volatile关键字生命；如果一个变量要被某个线程独享，可以通过ThreadLocalMap对象。ThreadLocalMap对象存储了一组以ThreadLocal.threadLocalHashCode为键，以本地线程变量为K-V值对，ThreadLocal对象就是当前线程的ThreadLocalMap的访问入口，每个ThreadLocal对象都包含一个独一无二的threadLocalHashCode值，以找到线程K-V值对中对应的本地线程变量。

## 锁优化

1. 适应性自旋
2. 锁消除
3. 锁粗化
4. 轻量级锁
5. 偏向锁

### 自旋锁与自适应自旋

### 锁消除

### 锁粗化

### 轻量级锁