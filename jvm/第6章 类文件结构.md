# 类文件结构

## 概述

各种平台的虚拟机与所有平台都统一使用的程序存储格式——字节码是构成平台无关性的基础。

## Class类文件的结构

Class文件是一组以8位字节为基础单位的二进制流，各数据项目严格按照顺序紧凑的排列在Class文件中，其中没有任何分隔符。

Class文件格式采用类似于C语言结构体的伪结构存储，这种伪结构中只有两种数据类型：无符号数和表。

无符号数属于基本数据类型，以u1、u2、u4、u8分别表示1、2、4、8个字节。用来描述数字、索引引用、数量值或字符串值。

表由多个无符号数或其他表作为数据项构成的复合数据类型，所有表一般以_info结尾。用于描述有层次关系的复合结构数据。Class文件本质上就是一张表。

1. 版本号
2. 常量池：字面量和符号引用
3. 访问标志
4. 类索引、父类索引与接口索引集合
5. 字段表集合
6. 方法表集合
7. 属性表集合


### 魔数与版本号

Class文件的头4个字节被称为魔数，用于确定这个文件是否为一个能被虚拟机接受的Class文件。

魔数后的四个字节为Class文件的版本号。

### 常量池

版本号之后的是常量池入口，常量池是Class文件结构中与其他项目关联最多的数据类型，也是占用Class文件空间最大的数据项目之一。是一个表类型数据结构。

常量容量计数值。

常量池中存储两大类常量：
1. 字面量：如文本字符串、被声明为final的常量值等。
2. 符号引用：
	1. 类和接口的全限定名
	2. 字段的名称和描述符
	3. 方法的名称和描述符

java进行编译时，不会像C或C++一样有“连接”步骤，而是在虚拟机加载Class文件的时候进行动态连接。Class文件中不会保存各个方法和字段的内存布局信息，虚拟机运行时，需要从常量池获得对应的符号引用，再在类创建时或运行时解析并翻译到具体的内存地址中。

### 访问标志

常量池之后，紧接着2个字节代表访问标志，用于识别一些类或接口层次的访问信息，包括：这个Class是类还是接口，是否定义为public类型，是否定义为abstract类型，是否被声明为final等。

### 类索引、父类索引与接口索引集合

类索引、父类索引与接口索引集合用于确定这个类的继承关系。

类索引用于确定这个类的全限定名，父类索引用于确定这个类的父类的全限定名，接口缩影集合用于描述这个类实现了哪些接口，按implements语句后的接口从左到右排列。

### 字段表集合

字段表用于描述接口或类中声明的变量。字段包括类级变量或实例级变量，但不包括在方法内部声明的变量。

字段信息包括：
1. 字段的作用域
2. 是static变量还是实例变量
3. 可变性（final）
4. 并发可见性（volatile）
5. 可否序列化（transient）
6. 字段数据类型
7. 字段名称

其中，字段名称、字段数据类型只能引用常量池中的常量来描述。

描述符的作用是用来描述字段的数据类型、方法的参数列表和返回值的。

### 方法表集合

方法表的结构如字段表一样，包括：
1. 访问标志
2. 名称索引
3. 描述符索引
4. 属性表集合

重载一个方法，除了要与原方法具有相同的简单名称外，还要求必须拥有一个与原方法不同的特种签名，即一个方法中各个参数在常量池中的字段符号引用的集合。因为返回值不包含在特征签名之中，因此java中无法仅仅依靠返回值的不同来对一个已有方法进行重载。

方法的代码存放在Code属性中。

### 属性表集合

Code属性

java程序方法体中的代码经过编译器处理之后，最终变成字节码指令存储在Code属性内，Code属性出现在方法表的属性集合之中，但并非所有的方法表都存在这个属性，如接口或者抽象类。

Exception属性

Exception属性的作用是列举出方法中可能抛出的受查异常，也就是方法描述时在throws关键字后面列举的异常。

LineNumberTable属性

LineNumberTable属性用于描述java源码行号与字节码行号的对应关系。

LocalVariableTable属性

LocalVariableTable属性用于描述栈帧中局部变量表中的变量与java源码中定义变量之间的关系。
