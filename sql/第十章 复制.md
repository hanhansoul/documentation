# 复制

复制解决的问题是让一台服务器的数据与其他服务器保持同步。

1. 基于行的复制
2. 基于语句的复制

通过在主库上记录二进制日志、在备库重放日志的方式来实现异步的数据复制。这意味着，在同一时间点备库上的数据可能与主库存在不一致，并且无法保证主备之间的延迟。

## 复制解决的问题

1. 数据分布
2. 负载均衡
3. 备份：复制既不是备份也不能取代备份
4. 高可用性和故障切换：避免单点故障
5. mysql升级测试

## 复制如何工作

1. 在主库上把数据更改记录到二进制日志中；
2. 备库从主库的日志复制到自己的中继日志中；
3. 备库读取中继日志中的事件，将其重放到备库数据之上。

详细步骤

1. 主库上记录二进制日志。在每次准备提交事务完成数据更新前，主库将数据更新的事件记录到二进制日志中。mysql会按事务提交的顺序而非每句语句的执行顺序来记录二进制日志。记录二进制日志后，主库会告诉存储引擎可以提交事务了。
2. 备库将主库的二进制日志复制到其本地的中继日志中。备库会启动一个I/O线程将接收到的事件记录到中继日志中，在主库上启动一个二进制转储线程读取主库上二进制日志中的事件。
3. 备库的sql线程执行最后一步，从中继日志中读取事件并在备库执行，从而实现备库数据的更新。

备库有两个运行的线程，主库有一个运行的线程。这种赋值架构实现了获取事件和重放事件的解耦，允许两个过程异步进行。但也限制复制过程在主库并发运行的查询只能串行执行，因为只有一个线程来重放中继日志中的事件。

### 配置复制

1. 在每台服务器上创建复制账号
2. 配置主库和备库
3. 通知备库连接到主库并从主库复制数据

### 启动复制

### 从另一个服务器开始复制

### 推荐的复制配置

## 复制的原理

### 基于语句的复制

基于语句的复制模式下，主库会记录那些造成数据更改的查询，当备库读取并重放事件时，实际上只是把主库执行过的sql再执行一遍。

优势：实现相当简单，二进制日志中的事件更加紧凑，节约带宽。

劣势：二进制日志中除了查询语句，还包括元数据信息如当前时间戳，以及一些无法被正确复制的sql，存储过程和触发器也可能出现问题；另一个问题是更新必须是串行的。

### 基于行的复制

将实际数据记录在二进制日志中，可以正确的复制每一行，一些语句可以被更加有效地复制。

由于无须重放更新主库数据的查询，使用基于行的复制模式能够更高效地复制数据。

### 复制模式比较

// TODO

1. 基于语句的复制模式的优点
2. 基于语句的复制模式的缺点
3. 基于行的复制模式的优点
4. 基于行的复制模式的缺点

### 复制文件

### 发送复制事件到其他备库

